FROM pytorch/pytorch:2.0.0-cuda11.7-cudnn8-runtime

# Çalışma dizinini ayarla
WORKDIR /app

# Ortam değişkenlerini ayarla
ENV MODEL_PATH=/app/models/2712.pt
ENV PYTHONUNBUFFERED=1

# Gerekli paketleri yükle
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \
    curl \
    python3-dev \
    build-essential \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Python bağımlılıklarını yükle
RUN pip3 install --no-cache-dir \
    runpod==0.13.0 \
    Pillow==9.5.0 \
    numpy==1.24.3 \
    opencv-python-headless==4.7.0.72

# Uygulama dosyalarını kopyala
COPY handler.py model.py utils.py /app/

# Model dizini oluştur
RUN mkdir -p /app/models

# Model indirme ve başlatma scripti oluştur
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Python versiyonu:"\n\
python3 --version\n\
\n\
echo "Yüklü pip paketleri:"\n\
pip3 list\n\
\n\
echo "Çalışma dizini: $(pwd)"\n\
\n\
# Model dosyasını indir\n\
if [ ! -f ${MODEL_PATH} ]; then\n\
    echo "Model indiriliyor..."\n\
    wget -q -O ${MODEL_PATH} https://raw.githubusercontent.com/Proq3n/solar-panel-analysis-runpod/305d4577bd68da5255bd703238cb5fd9b84b46ae/2712.pt\n\
    \n\
    # Model dosyasının indirilip indirilmediğini kontrol et\n\
    if [ -f ${MODEL_PATH} ]; then\n\
        echo "Model başarıyla indirildi: $(ls -la ${MODEL_PATH})"\n\
        \n\
        # Model dosyasının içeriğini kontrol et\n\
        echo "Model dosyası kontrol ediliyor..."\n\
        file_type=$(file ${MODEL_PATH})\n\
        echo "Model dosya tipi: $file_type"\n\
        \n\
        # İlk birkaç byte kontrol et (binary mi text mi)\n\
        head -c 20 ${MODEL_PATH} | hexdump -C\n\
    else\n\
        echo "HATA: Model indirme başarısız oldu"\n\
        exit 1\n\
    fi\n\
else\n\
    echo "Model zaten mevcut: $(ls -la ${MODEL_PATH})"\n\
fi\n\
\n\
# Uygulamayı başlat\n\
echo "RunPod API başlatılıyor..."\n\
python3 -u handler.py\n\
' > /app/start.sh && chmod +x /app/start.sh

# Uygulamayı başlat
CMD ["/app/start.sh"] 
